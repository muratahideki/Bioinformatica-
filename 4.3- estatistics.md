
## Normalização
### Normalização por tamanho da biblioteca (Size Factor Normalization)

```R
#  Normalizar os dados
dds <- estimateSizeFactors(dds)
normalized_counts <- counts(dds, normalized=TRUE)
```

Antes de qualquer transformação, o DESeq2 calcula um fator de normalização (size factor) para cada amostra, de modo que as contagens fiquem comparáveis.

Ele resolve o seguinte problema:

| Gene  | Amostra A | Amostra B |
| ----- | --------- | --------- |
| Gene1 | 1000      | 2000      |
| Gene2 | 500       | 1000      |
| Gene3 | 50        | 100       |

Aparentemente, todos os genes da amostra B têm o dobro das contagens da amostra A.

Mas isso não significa que eles estão mais expressos — pode ser apenas que a amostra B teve o dobro de reads sequenciados (ou seja, foi mais profundamente sequenciada).

O DESeq2 calcula um fator de escala (chamado size factor) para cada amostra, que corrige esse tipo de diferença.

Como o fator é calculado:

1) Primeiro é aplicado o logaritmo neperiano em todos os elementos das colunas;
- Na linha que originalmente for zero, vai resultar em indeterminação

2) Depois é calculado a média em cada linha (em cada gene portanto);
  - quando a média é calculado em logs, chama-se média geométrica
    
3) Vai ser fitrado a linha com indeterminação
 - Isso está relacionado com a solução do problema de quando pegamos amostras diferentes, pode ter genes deiferenciados apenas porque a amostra é de outro tecido. Nesse sentido a diferença de expressão não está relacionada com uma diferente condição induzida.
   
4) Em seguida, cada elemento em que foi aplicado o log vai ser subtraído pela média dos log de cada linha;<br>
  - log(read of gene X) - log(avarage of gene X) = log(read of gene X/avarage of gene X)

5) Em seguida em calculado a mediana de cada amostra
  - A mediana é boa para evitar valores extremos nas extremidades da amostra

6) Agora é calculado os "scaling factor" de cada amostra, elevando a mediana de cada amostra por e, isto é retirando a influência do log
7) Em seguida dividindo as reads pelo "scaling factor"

vídeo referência: https://www.youtube.com/watch?v=Wdt6jdi-NQo

### Heatmap

  Com os valores normalizados é calculado o log na base entre os genes de cada amostra. Nesse sentido, foi feito manualmente com esse codigo:

```R
log2fc <- log2(normalized_counts[, "IPT"] / normalized_counts[, "NIPT"])
```

| Gene  | Amostra A | Amostra B |  log2fc  |
| ----- | --------- | --------- |  ------  |
| Gene1 | 1000      | 2000      |    -1    |
| Gene2 | 500       | 1000      |     1    |

- Para o Gene1,  temos que o gene foi duas vezes mais reprimido
- Para o Gene2,  temos que o gene foi duas vezes mais expresso

```R
# Heatmap dos top 20 genes
top_genes <- head(order(abs(log2fc), decreasing=TRUE), 20)
```
  Neste código, ele esta pegando os 20 genes que mais tiveram diferença de expressão, não importa se mais expresso ou mais reprimido `abs()`



-  




